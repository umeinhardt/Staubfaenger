(function(){"use strict";let y=null,x=null,S=null,g=0;class M{constructor(i){this.cellSize=i,this.grid=new Map}clear(){this.grid.clear()}hash(i,t,e){return`${i},${t},${e}`}insert(i,t,e){const l=Math.floor((t.x-e)/this.cellSize),o=Math.floor((t.x+e)/this.cellSize),n=Math.floor((t.y-e)/this.cellSize),s=Math.floor((t.y+e)/this.cellSize),a=Math.floor((t.z-e)/this.cellSize),f=Math.floor((t.z+e)/this.cellSize);for(let r=l;r<=o;r++)for(let d=n;d<=s;d++)for(let z=a;z<=f;z++){const h=this.hash(r,d,z);this.grid.has(h)||this.grid.set(h,[]),this.grid.get(h).push(i)}}getNearby(i,t){const e=Math.floor((i.x-t)/this.cellSize),l=Math.floor((i.x+t)/this.cellSize),o=Math.floor((i.y-t)/this.cellSize),n=Math.floor((i.y+t)/this.cellSize),s=Math.floor((i.z-t)/this.cellSize),a=Math.floor((i.z+t)/this.cellSize),f=new Set;for(let r=e;r<=l;r++)for(let d=o;d<=n;d++)for(let z=s;z<=a;z++){const h=this.hash(r,d,z),u=this.grid.get(h);if(u)for(const m of u)f.add(m)}return f}}function C(c,i,t,e){const l=t.x-c.x,o=t.y-c.y,n=t.z-c.z,s=l*l+o*o+n*n,a=i+e;return s<=a*a}function $(c,i){const t=new M(i),e=[],l=new Set;for(let o=0;o<c.length;o++)t.insert(o,c[o].position,c[o].radius);for(let o=0;o<c.length;o++){const n=c[o],s=t.getNearby(n.position,n.radius);for(const a of s){if(o===a)continue;const f=c[a],r=o<a?`${o}:${a}`:`${a}:${o}`;l.has(r)||(l.add(r),C(n.position,n.radius,f.position,f.radius)&&e.push({id1:n.id,id2:f.id}))}}return e}function w(c,i,t,e){if(!y||!x||!S)return 0;const l=new M(e),o=new Set;let n=0;for(let s=0;s<t;s++){const a=y[s*3+0],f=y[s*3+1],r=y[s*3+2],d=x[s];l.insert(s,{x:a,y:f,z:r},d)}for(let s=c;s<i;s++){const a=y[s*3+0],f=y[s*3+1],r=y[s*3+2],d=x[s],z=l.getNearby({x:a,y:f,z:r},d);for(const h of z){if(s===h)continue;const u=s<h?`${s}:${h}`:`${h}:${s}`;if(o.has(u))continue;o.add(u);const m=y[h*3+0],b=y[h*3+1],k=y[h*3+2],p=x[h];C({x:a,y:f,z:r},d,{x:m,y:b,z:k},p)&&n*2+1<g&&(S[n*2+0]=s,S[n*2+1]=h,n++)}}return n}self.onmessage=c=>{const{type:i}=c.data;if(i==="initSharedBuffers"){const{positions:t,radii:e,collisions:l,maxEntities:o,maxCollisions:n}=c.data;t&&e&&l&&o&&n&&(y=new Float64Array(t),x=new Float64Array(e),S=new Int32Array(l),g=n)}else if(i==="detectCollisionsShared"){const{start:t,end:e,numEntities:l,cellSize:o}=c.data;if(t!==void 0&&e!==void 0&&l!==void 0&&o!==void 0){const n=w(t,e,l,o);self.postMessage({type:"collisionsComplete",count:n})}}else if(i==="detectCollisions"){const{entities:t,cellSize:e}=c.data;if(t&&e!==void 0){const l=$(t,e);self.postMessage({type:"collisionsResult",collisions:l})}}}})();
